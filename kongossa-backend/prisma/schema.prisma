// ------------------------------------------------------------
// Prisma Schema ‚Äî Rebuilt & Optimized for Role/Permission logic
// ------------------------------------------------------------

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // url      = env("DATABASE_URL")
}

// ---------------------------
// MODELS
// ---------------------------

model User {
  id                  Int       @id @default(autoincrement())
  role                String
  email               String    @unique
  emailVerifiedAt     DateTime? // ‚úÖ Added from Laravel migration
  fullName            String
  phoneNumber         String?   @unique
  phoneVerified       Boolean   @default(false)
  kycStatus           String    @default("pending")
  approvalStatus      String    @default("pending")
  companyName         String?
  legalForm           String? // matches company_legal_form
  managerName         String?
  companyPhone        String?
  companyAddress      String?
  businessDescription String?
  legalFormDocument   String? // renamed from trade_register_document
  walletBalance       Float     @default(0)
  currency            String    @default("USD")
  referralCode        String?   @unique
  referredBy          String?
  accountType         String    @default("personal")
  agentStatus         String?   @default("pending")
  businessName        String?
  profileImage        String?
  address             String
  country             String
  dateOfBirth         DateTime
  rewardsPoints       Float     @default(0)
  qrToken             String?    @unique
  qrCode              String?    @unique
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  passwordHash        String?
  status              String    @default("active") // ‚úÖ Added from Laravel migration
  rememberToken       String? // ‚úÖ Added
  stripeId            String? // ‚úÖ Added
  stripeConnectId     String?
  stripeChargesEnabled   Boolean  @default(false)
  stripePayoutsEnabled   Boolean  @default(false)
  stripeDetailsSubmitted Boolean  @default(false)
  pmType              String? // ‚úÖ Added
  pmLastFour          String? // ‚úÖ Added
  trialEndsAt         DateTime? // ‚úÖ Added
  userType            String    @default("personal") // ‚úÖ Added enum equivalent

  // Relations
  transactionLimits      TransactionLimits?
  sentTransactions       Transaction[]         @relation("SentTransactions")
  receivedTransactions   Transaction[]         @relation("ReceivedTransactions")
  refreshTokens          RefreshToken[]
  userRoles              UserRole[]
  otps                   Otp[]
  passwordResets         PasswordReset[]
  paymentMethods         PaymentMethod[]
  supportTickets         SupportTicket[]
  assignedSupportTickets SupportTicket[]       @relation("SupportAssignedTo")
  tontinesCreated        Tontine[]             @relation("TontineCreator")
  tontineCoAdminFor      Tontine[]             @relation("TontineCoAdmin")
  tontineMembers         TontineMember[]
  tontineContributions   TontineContribution[]
  tontineInvites         TontineInvite[]
  qrPayments             QRPayment[]           @relation("QRRecipient")
  remittancesAsAgent     Remittance[]          @relation("RemittanceAgent")
  savedContacts          SavedContact[]        @relation("SavedContactAgent")
  floatRequests          FloatRequest[]        @relation("FloatRequestAgent")
  subscriptions          Subscription[]
  sessions               Session[]
  budgets                Budget[]
  walletTopUps           WalletTopUp[]
  WalletPayouts          WalletPayout[]
}

model TransactionLimits {
  id            Int   @id @default(autoincrement())
  userId        Int   @unique
  daily         Float
  weeklyBudget  Float @default(0)
  monthlyBudget Float @default(0)
  yearlyBudget  Float @default(0)
  user          User  @relation(fields: [userId], references: [id], onDelete: Restrict, onUpdate: Cascade)

  @@map("TransactionLimits")
}

model Transaction {
  id              Int      @id @default(autoincrement())
  transactionId   String   @unique
  senderId        Int
  recipientId     Int?
  amount          Decimal? @db.Decimal(10,2)
  currency        String   @default("USD")
  type            String
  status          String   @default("pending")
  paymentMethod   String?
  description     String?
  fee             Decimal? @db.Decimal(10,2) @default(0)
  exchangeRate    Float?
  referenceNumber String?
  qrCode          String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  sender    User  @relation("SentTransactions", fields: [senderId], references: [id])
  recipient User? @relation("ReceivedTransactions", fields: [recipientId], references: [id])

  @@map("Transaction")
}

model Role {
  id              Int              @id @default(autoincrement())
  name            String           @unique
  description     String?
  updatedAt       DateTime         @default(now()) // temporary default
  userRoles       UserRole[]
  rolePermissions RolePermission[]

  @@map("Role")
}

model Permission {
  id              Int              @id @default(autoincrement())
  action          String
  resource        String
  description     String?
  name            String           @default("default_name") // temporary default
  updatedAt       DateTime         @default(now()) // temporary default
  rolePermissions RolePermission[]

  @@unique([action, resource])
  @@map("Permission")
}

model UserRole {
  id     Int  @id @default(autoincrement())
  userId Int
  roleId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  role   Role @relation(fields: [roleId], references: [id], onDelete: Restrict, onUpdate: Cascade)

  @@unique([userId, roleId], name: "userId_roleId")

  @@map("UserRole")
}

model RolePermission {
  id           Int        @id @default(autoincrement())
  roleId       Int
  permissionId Int
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Restrict, onUpdate: Cascade)

  @@unique([roleId, permissionId], name: "role_permission_unique") // ‚úÖ named composite unique
  @@map("RolePermission")
}

model RefreshToken {
  id           Int           @id @default(autoincrement())
  tokenHash    String
  userId       Int
  expiresAt    DateTime
  revoked      Boolean       @default(false)
  createdAt    DateTime      @default(now())
  replacedById Int?          @unique // ‚úÖ required for one-to-one
  user         User          @relation(fields: [userId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  replacedBy   RefreshToken? @relation("ReplacedBy", fields: [replacedById], references: [id], onDelete: SetNull, onUpdate: Cascade)
  replacement  RefreshToken? @relation("ReplacedBy")

  @@map("RefreshToken")
}

model Otp {
  id        Int      @id @default(autoincrement())
  email     String
  codeHash  String
  purpose   String
  expiresAt DateTime
  used      Boolean  @default(false)
  attempts  Int      @default(0)
  userId    Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Restrict, onUpdate: Cascade)

  @@map("Otp")
}

model PasswordReset {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("PasswordReset")
}

model PaymentMethod {
  id              Int      @id @default(autoincrement())
  userId          Int

  type            String   // card, bank, mobile_money
  provider        String?

  // üîê Stripe-safe fields
  stripePmId      String?  @unique
  stripeCustomer  String?
  brand           String?
  lastFour        String?
  expiryMonth     Int?
  expiryYear      Int?

  // legacy/manual (optional)
  accountName     String?
  accountNumber   String?
  bankName        String?
  expiryDate      String?

  isDefault       Boolean  @default(false)
  isVerified      Boolean  @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model SupportTicket {
  id           Int      @id @default(autoincrement())
  ticketId     String?  @unique
  userId       Int
  subject      String
  description  String
  category     String?
  priority     String   @default("medium")
  status       String   @default("open")
  assignedToId Int? // admin user id (optional)
  attachments  String[] @default([])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user       User  @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  assignedTo User? @relation("SupportAssignedTo", fields: [assignedToId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  @@index([userId])
  @@index([assignedToId])
  @@map("SupportTicket")
}

model Tontine {
  id               Int       @id @default(autoincrement())
  createdBy        Int       @map("created_by")
  name             String
  type             String
  contributionAmount Decimal  @db.Decimal(10,2) @map("contribution_amount")
  frequency        String     // renamed from contributionFrequency
  durationMonths   Int?       @map("duration_months")
  status           String
  maxMembers       Int?       @map("max_members")
  stripePriceId    String?    @map("stripe_price_id")
  totalPot         Decimal    @default(0) @db.Decimal(10,2)
  startDate          DateTime?  @map("start_date")
  createdAt        DateTime   @default(now()) @map("created_at")
  updatedAt        DateTime   @updatedAt @map("updated_at")

  creator          User @relation("TontineCreator", fields: [createdBy], references: [id])

  coAdmins          User[] @relation("TontineCoAdmin")
  members          TontineMember[]
  invites          TontineInvite[]
  payouts          TontinePayout[]
  @@map("tontines")
}

model TontineMember {
  id              Int      @id @default(autoincrement())
  tontineId       Int      @map("tontine_id")
  userId          Int      @map("user_id")
  priorityOrder   Int?     @map("priority_order")
  isAdmin         Boolean  @default(false) @map("is_admin")

  joinedAt        DateTime @default(now()) @map("joined_at")

  tontine         Tontine  @relation(fields: [tontineId], references: [id])
  user            User     @relation(fields: [userId], references: [id])
  contributions   TontineContribution[]
  payouts         TontinePayout[]

  @@unique([tontineId, userId])
  @@map("tontine_members")
}


model TontineContribution {
  id                 Int       @id @default(autoincrement())
  tontineMemberId    Int       @map("tontine_member_id")
  amount             Decimal   @db.Decimal(10,2)
  roundNumber        Int       @default(1)
  contributionDate   DateTime? @map("contribution_date")
  status             String
  stripeSessionId    String?   @unique
  paymentMethod      String?   // <-- add this
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  userId             Int?
  user               User? @relation(fields: [userId], references: [id])
  tontineMember      TontineMember @relation(fields: [tontineMemberId], references: [id], onDelete: Cascade)

  @@map("tontine_contributions")
}


model QRPayment {
  id          Int       @id @default(autoincrement())
  qrCode      String    @unique
  recipientId Int
  amount      Float?
  currency    String    @default("USD")
  description String?
  isActive    Boolean   @default(true)
  expiryDate  DateTime?
  usageLimit  Int?
  usageCount  Int       @default(0)
  paymentType String    @default("one_time") // one_time, recurring, open_amount
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  recipient User @relation("QRRecipient", fields: [recipientId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([recipientId])
  @@map("QRPayment")
}

model Remittance {
  id                  Int      @id @default(autoincrement())
  agentId             Int
  senderDetails       Json // { name, phone, country }
  recipientDetails    Json // { name, phone, country, bank_name, account_number }
  bankName            String?
  accountNumber       String?
  sourceAmount        Float
  sourceCurrency      String?
  destinationAmount   Float?
  destinationCurrency String?
  exchangeRate        Float?
  deliveryMethod      String
  status              String   @default("pending")
  transactionId       String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  agent User @relation("RemittanceAgent", fields: [agentId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([agentId])
  @@map("Remittance")
}

model SavedContact {
  id            Int      @id @default(autoincrement())
  agentId       Int
  contactType   String
  name          String
  phone         String?
  country       String?
  bankName      String?
  accountNumber String?
  createdAt     DateTime @default(now())

  agent User @relation("SavedContactAgent", fields: [agentId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([agentId])
  @@map("SavedContact")
}

model SystemSettings {
  id                  Int      @id @default(autoincrement())
  transferFeePercent  Float    @default(1.5)
  withdrawalFeeFlat   Float    @default(2.5)
  forexMarkupPercent  Float    @default(2.0)
  cryptoMarkupPercent Float    @default(2.5)
  tontineFeePercent   Float    @default(0.5)
  updatedAt           DateTime @updatedAt
  createdAt           DateTime @default(now())

  @@map("SystemSettings")
}

model FloatRequest {
  id        Int      @id @default(autoincrement())
  agentId   Int
  amount    Float
  currency  String   @default("USD")
  status    String   @default("pending")
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agent User @relation("FloatRequestAgent", fields: [agentId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([agentId])
  @@map("FloatRequest")
}

model Session {
  id           String  @id
  userId       Int?
  ipAddress    String? @db.VarChar(45)
  userAgent    String?
  payload      String
  lastActivity Int
  user         User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
}

model Cache {
  key        String @id
  value      String
  expiration Int
}

model CacheLock {
  key        String @id
  owner      String
  expiration Int
}

model Job {
  id          Int    @id @default(autoincrement())
  queue       String
  payload     String
  attempts    Int
  reservedAt  Int?
  availableAt Int
  createdAt   Int

  @@index([queue])
}

model JobBatch {
  id           String  @id
  name         String
  totalJobs    Int
  pendingJobs  Int
  failedJobs   Int
  failedJobIds String
  options      String?
  cancelledAt  Int?
  createdAt    Int
  finishedAt   Int?
}

model FailedJob {
  id         Int      @id @default(autoincrement())
  uuid       String   @unique
  connection String
  queue      String
  payload    String
  exception  String
  failedAt   DateTime @default(now())
}

// --------------------
// Budget / Expense
// --------------------
model Budget {
  id          Int              @id @default(autoincrement())
  userId      Int
  name        String
  description String?
  period      String           @default("monthly")
  totalAmount Float
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  categories  BudgetCategory[]
}

model BudgetCategory {
  id          Int       @id @default(autoincrement())
  budgetId    Int
  description String?
  name        String
  color       String?
  limitAmount Float
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  budget      Budget    @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  expenses    Expense[]
}

model Expense {
  id               Int            @id @default(autoincrement())
  budgetCategoryId Int
  title            String
  amount           Float
  expenseDate      DateTime
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  budgetCategory   BudgetCategory @relation(fields: [budgetCategoryId], references: [id], onDelete: Cascade)
}

// --------------------
// Tontine related additions
// --------------------
model TontinePayout {
  id              Int       @id @default(autoincrement())
  tontineMemberId Int       @map("tontine_member_id")
  amount          Decimal    @db.Decimal(10,2)
  payoutDate      DateTime   @map("payout_date")
  status          String
  tontineId Int @map("tontine_id")
  tontine   Tontine @relation(fields: [tontineId], references: [id])
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  tontineMember   TontineMember @relation(fields: [tontineMemberId], references: [id])

  @@map("tontine_payouts")
}

model TontineInvite {
  id          Int      @id @default(autoincrement())
  tontineId   Int      @map("tontine_id")
  userId      Int?     @map("user_id")
  email       String
  inviteToken String   @unique @map("invite_token")
  status      String   @default("pending")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  tontine     Tontine @relation(fields: [tontineId], references: [id])
  user        User?   @relation(fields: [userId], references: [id])

  @@map("tontine_invites")
}

// --------------------
// Subscription
// --------------------
model Subscription {
  id           Int       @id @default(autoincrement())
  userId       Int
  type         String
  stripeId     String    @unique
  stripeStatus String
  stripePrice  String?
  quantity     Int?
  trialEndsAt  DateTime?
  endsAt       DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscriptionItems SubscriptionItem[]

  @@index([userId, stripeStatus])
}

model SubscriptionItem {
  id             Int      @id @default(autoincrement())
  subscriptionId Int
  stripeId       String   @unique
  stripeProduct  String
  stripePrice    String
  quantity       Int?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId, stripePrice])
}

model WalletTopUp {
  id               Int      @id @default(autoincrement())
  userId           Int
  amount           Float
  currency         String   @default("USD")
  stripeIntentId   String   @unique
  stripeChargeId   String?
  paymentMethodId  String?
  status           String   // pending | succeeded | failed
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model WalletPayout {
  id               Int      @id @default(autoincrement())
  userId           Int
  amount           Float
  fee              Float
  netAmount        Float
  currency         String

  stripeTransferId String?
  stripePayoutId   String?

  status           String   // pending | processing | completed | failed
  failureReason    String?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}


